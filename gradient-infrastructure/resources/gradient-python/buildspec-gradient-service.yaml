version: 0.2
env:
  shell: bash

batch:
  fast-fail: true
  build-list:
    - identifier: gradient-service-domain
      env:
        variables:
          MODULE_NAME: gradient-service-domain
    - identifier: gradient-service-inference
      env:
        variables:
          MODULE_NAME: gradient-service-inference

phases:
  install:
    runtime-versions:
      python: 3.7
    commands:
      - pip install -r requirements.txt
      - python -m venv $MODULE_NAME/environment
      - pushd $MODULE_NAME && source environment/bin/activate && pip install -r requirements/requirements.txt && popd

  build:
    commands:
      - pushd $MODULE_NAME && source environment/bin/activate && inv build && inv test && popd

  post_build:
    commands:
      - pushd $MODULE_NAME && source environment/bin/activate && inv publish && popd

reports:
  test-gradient-service-domain:
    files:
      - "*.xml"
    base-directory: gradient-service-domain/build/pytest/reports
    file-format: JUNITXML
  test-gradient-service-inference:
    files:
      - "*.xml"
    base-directory: gradient-service-inference/build/pytest/reports
    file-format: JUNITXML


cache:
  paths:
    - /root/.cache/pip/**/*
    - /root/gradient-service-inference/.hypothesis
    - /root/gradient-service-inference/tests/.hypothesis
